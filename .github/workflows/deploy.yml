name: Deploy to CapRover

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create deployment tarball
        run: |
          tar -czf ../deploy.tar \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='videos' \
            --exclude='assets' \
            --exclude='*.tar' \
            --exclude='*.log' \
            --exclude='nohup.out' \
            --exclude='.venv' \
            .
          mv ../deploy.tar ./deploy.tar

      
      - name: Deploy to CapRover
        run: |
          npx -y caprover deploy \
            --caproverUrl ${{ secrets.CAPROVER_SERVER }} \
            --appToken ${{ secrets.CAPROVER_TOKEN }} \
            --appName ${{ secrets.CAPROVER_APP }} \
            --tarFile deploy.tar
      
      # Sync large files to persistent storage (only if SSH credentials are configured)
      - name: Sync videos to persistent storage
        if: ${{ secrets.SERVER_IP != '' && secrets.SERVER_SSH_KEY != '' }}
        run: |
          # Install SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add server to known hosts
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # Sync videos with rsync (only uploads changed files)
          if [ -d "videos" ] && [ "$(ls -A videos)" ]; then
            rsync -avz --checksum -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
              videos/ \
              ubuntu@${{ secrets.SERVER_IP }}:/var/lib/docker/volumes/captain--${{ secrets.CAPROVER_APP }}--videos/_data/
            echo "✓ Videos synced successfully"
          else
            echo "⊘ No videos to sync"
          fi
      
      - name: Sync assets to persistent storage
        if: ${{ secrets.SERVER_IP != '' && secrets.SERVER_SSH_KEY != '' }}
        run: |
          # Sync assets with rsync (only uploads changed files)
          if [ -d "assets" ] && [ "$(ls -A assets)" ]; then
            rsync -avz --checksum -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
              assets/ \
              ubuntu@${{ secrets.SERVER_IP }}:/var/lib/docker/volumes/captain--${{ secrets.CAPROVER_APP }}--assets/_data/
            echo "✓ Assets synced successfully"
          else
            echo "⊘ No assets to sync"
          fi
          
          # Cleanup
          rm -f ~/.ssh/deploy_key
