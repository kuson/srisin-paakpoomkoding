<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Srisin Family</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- TinyMCE: Using no-api-key for demo. Get free API key at https://www.tiny.cloud/get-tiny/ for production -->
    <script src="https://cdn.tiny.cloud/1/tdgb3rdq9wlknv65psik91chuzt2sq05ch4703bzi4qvtvw6/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-gear-fill me-2"></i>Admin Panel
            </a>
            <div class="d-flex">
                <a href="/index.html" class="btn btn-outline-secondary me-2" target="_blank">
                    <i class="bi bi-box-arrow-up-right me-1"></i>View Site
                </a>
                <button class="btn btn-outline-danger" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Content Form -->
            <div class="col-lg-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            <span id="formTitle">Create New Content</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="contentForm">
                            <input type="hidden" id="contentId">
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="body" class="form-label">Content</label>
                                <textarea id="body" class="form-control" rows="8"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tag" class="form-label">Tag</label>
                                    <input type="text" class="form-control" id="tag" value="Story">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">Date</label>
                                    <input type="text" class="form-control" id="date" placeholder="December 2025">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Media Files</label>
                                
                                <!-- Drag and Drop Zone -->
                                <div id="dropZone" class="drop-zone">
                                    <div class="drop-zone-content">
                                        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #5b8dee;"></i>
                                        <p class="mb-2 fw-bold">Drag & Drop Images Here</p>
                                        <p class="text-muted small">or</p>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('fileUpload').click()">
                                            <i class="bi bi-folder2-open me-1"></i>Browse Files
                                        </button>
                                        <input type="file" class="d-none" id="fileUpload" multiple accept="image/*,video/*,.pdf,.doc,.docx,.txt,.zip">
                                        <p class="text-muted small mt-2">Supports: Images, Videos, PDF, Documents</p>
                                    </div>
                                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                                        <div class="progress">
                                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-center mt-2 small" id="uploadStatus">Uploading...</p>
                                    </div>
                                </div>
                                
                                <div id="existingMedia" class="mt-3"></div>
                                <div id="mediaPreview" class="mt-2"></div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>Save Content
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Content List -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>Published Content
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadContent()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="contentList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .drop-zone {
            border: 3px dashed #5b8dee;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            background: #e9ecef;
            border-color: #4a7cd9;
        }
        
        .drop-zone.drag-over {
            background: #e7f1ff;
            border-color: #0d6efd;
            transform: scale(1.02);
        }
        
        .drop-zone-content {
            pointer-events: none;
        }
        
        .upload-progress {
            padding: 1rem;
        }
        
        .media-thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
        
        .media-thumbnail-card {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 0.5rem;
            background: white;
            cursor: move;
            transition: all 0.2s;
        }
        
        .media-thumbnail-card:hover {
            border-color: #5b8dee;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .media-thumbnail-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
    <script>
        let editor;
        let uploadedMedia = [];

        // Initialize TinyMCE
        tinymce.init({
            selector: '#body',
            height: 300,
            menubar: false,
            plugins: 'lists link image code',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link | code',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
            extended_valid_elements: 'a[href|class|target|download],div[class|style],span[class|style],button[class|onclick|type],i[class]',
            valid_children: '+body[style],+div[a|button|i]',
            allow_html_in_named_anchor: true
        });

        // Drag and Drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileUpload');
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }, false);
        
        // Handle file selection from browse button
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        // Upload files
        async function handleFiles(files) {
            const preview = document.getElementById('mediaPreview');
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (files.length === 0) return;
            
            progressContainer.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Update progress
                    const percent = Math.round(((i + 1) / files.length) * 100);
                    progressBar.style.width = percent + '%';
                    uploadStatus.textContent = `Uploading ${i + 1} of ${files.length}: ${file.name}`;
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        uploadedMedia.push({
                            url: data.url,
                            type: data.type,
                            filename: data.filename
                        });
                        
                        // Show preview badge
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success me-2 mb-2';
                        badge.innerHTML = `<i class="bi bi-check-circle me-1"></i>${file.name}`;
                        preview.appendChild(badge);
                    } else {
                        // Show error badge
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-danger me-2 mb-2';
                        badge.innerHTML = `<i class="bi bi-x-circle me-1"></i>${file.name} - Failed`;
                        preview.appendChild(badge);
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-danger me-2 mb-2';
                    badge.innerHTML = `<i class="bi bi-x-circle me-1"></i>${file.name} - Error`;
                    preview.appendChild(badge);
                }
            }
            
            // Hide progress after completion
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 1000);
            
            // Refresh existing media display
            renderExistingMedia();
            
            // Clear file input
            fileInput.value = '';
        }

        // Form submission
        document.getElementById('contentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contentId = document.getElementById('contentId').value;
            const title = document.getElementById('title').value;
            const body = tinymce.get('body').getContent();
            const tag = document.getElementById('tag').value;
            const date = document.getElementById('date').value;
            
            const contentData = {
                title,
                body,
                tag,
                date,
                media: uploadedMedia
            };
            
            const url = contentId ? `/api/content/${contentId}` : '/api/content';
            const method = contentId ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(contentData)
                });
                
                const data = await response.json();
                if (data.success) {
                    resetForm();
                    loadContent();
                    alert('Content saved successfully!');
                }
            } catch (error) {
                alert('Failed to save content');
                console.error(error);
            }
        });

        // Load content list
        async function loadContent() {
            try {
                const response = await fetch('/api/content');
                const content = await response.json();
                
                const listDiv = document.getElementById('contentList');
                if (content.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted text-center py-4">No content yet. Create your first post!</p>';
                    return;
                }
                
                listDiv.innerHTML = content.map(item => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">${item.title}</h6>
                                    <small class="text-muted">
                                        <span class="badge bg-secondary">${item.tag}</span>
                                        ${item.date}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editContent(${item.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteContent(${item.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${item.media && item.media.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-paperclip me-1"></i>${item.media.length} file(s)
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Edit content
        async function editContent(id) {
            try {
                const response = await fetch('/api/content');
                const content = await response.json();
                const item = content.find(c => c.id === id);
                
                if (item) {
                    document.getElementById('contentId').value = item.id;
                    document.getElementById('title').value = item.title;
                    tinymce.get('body').setContent(item.body);
                    document.getElementById('tag').value = item.tag;
                    document.getElementById('date').value = item.date;
                    uploadedMedia = item.media || [];
                    
                    // Show existing media with thumbnails
                    renderExistingMedia();
                    
                    document.getElementById('formTitle').textContent = 'Edit Content';
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Render existing media with thumbnails
        function renderExistingMedia() {
            const container = document.getElementById('existingMedia');
            if (!uploadedMedia || uploadedMedia.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<div class="mb-2 fw-bold"><i class="bi bi-images me-2"></i>Uploaded Media (' + uploadedMedia.length + '):</div>';
            const mediaGrid = document.createElement('div');
            mediaGrid.className = 'media-thumbnail-grid';
            
            uploadedMedia.forEach((media, index) => {
                const mediaCard = document.createElement('div');
                mediaCard.className = 'media-thumbnail-card';
                mediaCard.draggable = true;
                mediaCard.dataset.index = index;
                
                // Drag events for reordering
                mediaCard.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', index);
                    mediaCard.style.opacity = '0.5';
                });
                
                mediaCard.addEventListener('dragend', (e) => {
                    mediaCard.style.opacity = '1';
                });
                
                mediaCard.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                mediaCard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(mediaCard.dataset.index);
                    
                    if (fromIndex !== toIndex) {
                        // Reorder array
                        const item = uploadedMedia.splice(fromIndex, 1)[0];
                        uploadedMedia.splice(toIndex, 0, item);
                        renderExistingMedia();
                    }
                });
                
                // Thumbnail
                if (media.type === 'image') {
                    const img = document.createElement('img');
                    img.src = media.url;
                    img.className = 'img-thumbnail mb-1';
                    img.style.width = '100%';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    mediaCard.appendChild(img);
                } else if (media.type === 'video') {
                    const video = document.createElement('div');
                    video.className = 'bg-dark text-white text-center mb-1 d-flex align-items-center justify-content-center';
                    video.style.height = '80px';
                    video.innerHTML = '<i class="bi bi-play-circle" style="font-size: 2rem;"></i>';
                    mediaCard.appendChild(video);
                } else {
                    const file = document.createElement('div');
                    file.className = 'bg-light text-center mb-1 d-flex align-items-center justify-content-center';
                    file.style.height = '80px';
                    file.innerHTML = '<i class="bi bi-file-earmark" style="font-size: 2rem;"></i>';
                    mediaCard.appendChild(file);
                }
                
                // Filename
                const filename = document.createElement('div');
                filename.className = 'small text-truncate';
                filename.textContent = media.filename || 'File';
                filename.style.fontSize = '0.7rem';
                mediaCard.appendChild(filename);
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0 m-1';
                deleteBtn.style.padding = '0.1rem 0.3rem';
                deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
                deleteBtn.onclick = () => {
                    if (confirm('Remove this file?')) {
                        uploadedMedia.splice(index, 1);
                        renderExistingMedia();
                    }
                };
                mediaCard.appendChild(deleteBtn);
                
                // Order indicator
                const order = document.createElement('div');
                order.className = 'badge bg-secondary position-absolute bottom-0 start-0 m-1';
                order.style.fontSize = '0.6rem';
                order.textContent = index + 1;
                mediaCard.appendChild(order);
                
                mediaGrid.appendChild(mediaCard);
            });
            
            container.appendChild(mediaGrid);
        }

        // Delete content
        async function deleteContent(id) {
            if (!confirm('Are you sure you want to delete this content?')) return;
            
            try {
                const response = await fetch(`/api/content/${id}`, {method: 'DELETE'});
                const data = await response.json();
                
                if (data.success) {
                    loadContent();
                }
            } catch (error) {
                console.error('Failed to delete content:', error);
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('contentForm').reset();
            document.getElementById('contentId').value = '';
            tinymce.get('body').setContent('');
            uploadedMedia = [];
            
            const mediaPreview = document.getElementById('mediaPreview');
            if (mediaPreview) mediaPreview.innerHTML = '';
            
            const existingMedia = document.getElementById('existingMedia');
            if (existingMedia) existingMedia.innerHTML = '';
            
            document.getElementById('formTitle').textContent = 'Create New Content';
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {method: 'POST'});
                window.location.href = '/admin';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Load content on page load
        loadContent();
        
        // Check if edit parameter is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');
        if (editId) {
            // Wait for TinyMCE to initialize then load the content
            setTimeout(() => editContent(parseInt(editId)), 500);
        }
    </script>
</body>
</html>
