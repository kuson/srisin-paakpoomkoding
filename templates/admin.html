<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Srisin Family</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-gear-fill me-2"></i>Admin Panel
            </a>
            <div class="d-flex">
                <a href="/index.html" class="btn btn-outline-secondary me-2" target="_blank">
                    <i class="bi bi-box-arrow-up-right me-1"></i>View Site
                </a>
                <button class="btn btn-outline-danger" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Content Form -->
            <div class="col-lg-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>
                            <span id="formTitle">Create New Content</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="contentForm">
                            <input type="hidden" id="contentId">
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="body" class="form-label">Content</label>
                                <textarea id="body" class="form-control" rows="8"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tag" class="form-label">Tag</label>
                                    <input type="text" class="form-control" id="tag" value="Story">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">Date</label>
                                    <input type="text" class="form-control" id="date" placeholder="December 2025">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Media Files</label>
                                <input type="file" class="form-control" id="fileUpload" multiple>
                                <small class="form-text text-muted">Upload images, videos, or documents</small>
                                <div id="mediaPreview" class="mt-2"></div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>Save Content
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Content List -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>Published Content
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadContent()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="contentList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let editor;
        let uploadedMedia = [];

        // Initialize TinyMCE
        tinymce.init({
            selector: '#body',
            height: 300,
            menubar: false,
            plugins: 'lists link image code',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link | code',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }'
        });

        // File upload handling
        document.getElementById('fileUpload').addEventListener('change', async (e) => {
            const files = e.target.files;
            const preview = document.getElementById('mediaPreview');
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        uploadedMedia.push({
                            url: data.url,
                            type: data.type,
                            filename: data.filename
                        });
                        
                        // Show preview
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success me-2 mb-2';
                        badge.innerHTML = `<i class="bi bi-check-circle me-1"></i>${file.name}`;
                        preview.appendChild(badge);
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                }
            }
        });

        // Form submission
        document.getElementById('contentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contentId = document.getElementById('contentId').value;
            const title = document.getElementById('title').value;
            const body = tinymce.get('body').getContent();
            const tag = document.getElementById('tag').value;
            const date = document.getElementById('date').value;
            
            const contentData = {
                title,
                body,
                tag,
                date,
                media: uploadedMedia
            };
            
            const url = contentId ? `/api/content/${contentId}` : '/api/content';
            const method = contentId ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(contentData)
                });
                
                const data = await response.json();
                if (data.success) {
                    resetForm();
                    loadContent();
                    alert('Content saved successfully!');
                }
            } catch (error) {
                alert('Failed to save content');
                console.error(error);
            }
        });

        // Load content list
        async function loadContent() {
            try {
                const response = await fetch('/api/content');
                const content = await response.json();
                
                const listDiv = document.getElementById('contentList');
                if (content.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted text-center py-4">No content yet. Create your first post!</p>';
                    return;
                }
                
                listDiv.innerHTML = content.map(item => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">${item.title}</h6>
                                    <small class="text-muted">
                                        <span class="badge bg-secondary">${item.tag}</span>
                                        ${item.date}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editContent(${item.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteContent(${item.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${item.media && item.media.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-paperclip me-1"></i>${item.media.length} file(s)
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Edit content
        async function editContent(id) {
            try {
                const response = await fetch('/api/content');
                const content = await response.json();
                const item = content.find(c => c.id === id);
                
                if (item) {
                    document.getElementById('contentId').value = item.id;
                    document.getElementById('title').value = item.title;
                    tinymce.get('body').setContent(item.body);
                    document.getElementById('tag').value = item.tag;
                    document.getElementById('date').value = item.date;
                    uploadedMedia = item.media || [];
                    
                    document.getElementById('formTitle').textContent = 'Edit Content';
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Delete content
        async function deleteContent(id) {
            if (!confirm('Are you sure you want to delete this content?')) return;
            
            try {
                const response = await fetch(`/api/content/${id}`, {method: 'DELETE'});
                const data = await response.json();
                
                if (data.success) {
                    loadContent();
                }
            } catch (error) {
                console.error('Failed to delete content:', error);
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('contentForm').reset();
            document.getElementById('contentId').value = '';
            tinymce.get('body').setContent('');
            uploadedMedia = [];
            document.getElementById('mediaPreview').innerHTML = '';
            document.getElementById('formTitle').textContent = 'Create New Content';
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {method: 'POST'});
                window.location.href = '/admin';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Load content on page load
        loadContent();
    </script>
</body>
</html>
